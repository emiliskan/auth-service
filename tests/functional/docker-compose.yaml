version: "3.8"


x-env: &x-env
  env_file:
    - env_file


services:
  backend_auth:
    restart: unless-stopped
    container_name: backend_auth
    build:
      context: backend_auth
      args:
        POETRY_PARAMS: ""
    ports:
      - "5000:5000"
    volumes:
      - ../../../backend_auth/:/app/
    depends_on:
      - postgres_auth
      - redis_auth
    networks:
      - internal
      - web
    <<: *x-env

  tests:
    container_name: tests
    build:
      args:
        POETRY_PARAMS: ""
      context: ../../
    entrypoint: /app/tests/functional/entrypoint.sh
    volumes:
      - ../../../backend_api/:/app/
    depends_on:
      - es
      - redis
      - backend_api
    <<: *x-env

  postgres_auth:
    restart: unless-stopped
    container_name: postgres
    image: library/postgres:13.2
    ports:
      - "15433:5432"
    volumes:
      - postgresauthdata:/var/lib/postgresql/data
    networks:
      - internal
    <<: *x-env

  redis_auth:
    restart: unless-stopped
    container_name: redis
    image: redis:6.2
    volumes:
      - redisauthdata:/data
    networks:
      - internal

volumes:
  postgresauthdata:
  redisauthdata: